<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- PWAå¯¾å¿œã®metaã‚¿ã‚° -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="åŒ»ç™‚è¨˜éŒ²">
    <meta name="theme-color" content="#2563eb">
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="./icon-192.png">
    <title>åŒ»ç™‚è¨˜éŒ²ã‚¢ãƒ—ãƒª</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, sans-serif; background: #f5f5f5; padding: 0; margin: 0; }
        .container { max-width: 100%; margin: 0 auto; padding: 0; }
        .header { background: #2563eb; color: white; padding: 16px; border-radius: 0; margin-bottom: 0; }
        .card { background: white; padding: 16px; border-radius: 0; margin-bottom: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .card-clickable { background: white; padding: 16px; border-radius: 8px; margin-bottom: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; transition: all 0.2s; }
        .card-clickable:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.15); background: #f9fafb; }
        .alert-box { background: #fef2f2; border: 2px solid #ef4444; padding: 16px; border-radius: 12px; margin-bottom: 12px; }
        .alert-box h2 { color: #991b1b; margin-bottom: 8px; }
        .alert-item { color: #991b1b; font-weight: bold; font-size: 18px; margin: 4px 0; }
        .adl-icon { font-size: 64px; text-align: center; }
        .info-row { display: flex; justify-content: space-between; align-items: center; margin: 8px 0; }
        .badge { padding: 6px 12px; border-radius: 20px; font-size: 14px; display: inline-block; }
        .badge-active { background: #dbeafe; color: #1e40af; }
        .badge-inactive { background: #f3f4f6; color: #6b7280; }
        .badge-warning { background: #fee2e2; color: #991b1b; }
        .badge-observation { background: #fef3c7; color: #92400e; }
        .med-item { border-left: 4px solid #2563eb; padding-left: 12px; margin: 12px 0; }
        .button { background: #2563eb; color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; width: 100%; }
        .button:hover { background: #1d4ed8; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; margin: 8px 0; font-size: 16px; }
        .tab-container { display: flex; gap: 4px; margin-bottom: 0; background: white; padding: 8px; border-radius: 0; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .tab { flex: 1; padding: 10px 16px; border: none; border-radius: 6px; cursor: pointer; background: #f3f4f6; font-weight: 500; white-space: nowrap; font-size: 14px; text-align: center; min-width: 0; }
        .tab.active { background: #2563eb; color: white; }
        .adl-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin: 16px 0; }
        .adl-button { padding: 16px; border: 2px solid #d1d5db; border-radius: 8px; cursor: pointer; background: white; text-align: center; }
        .adl-button.selected { border-color: #2563eb; background: #eff6ff; }
        .adl-button .icon { font-size: 36px; }
        .adl-button .label { font-size: 12px; margin-top: 8px; }
        .list-item { background: #f9fafb; padding: 12px; border-radius: 8px; margin: 8px 0; }
        .delete-btn { color: #dc2626; font-weight: bold; cursor: pointer; padding: 4px 12px; }
        .flex-row { display: flex; gap: 8px; }
        h2 { font-size: 18px; font-weight: bold; margin-bottom: 12px; }
        h3 { font-size: 16px; font-weight: bold; margin: 16px 0 8px 0; }
        .hidden { display: none; }
        .summary-text { 
            line-height: 1.8; 
            color: #374151; 
            font-size: 15px;
        }
        .summary-section {
            margin-bottom: 16px;
        }
        .summary-section-title {
            font-weight: bold;
            color: #2563eb;
            margin-bottom: 8px;
            font-size: 16px;
        }
        .warning-text {
            color: #dc2626;
            font-weight: bold;
        }
        /* ã€Œãªã—ã€ç™»éŒ²æ¸ˆã¿ã®è¡¨ç¤º */
        .none-registered-box {
            background: #f0fdf4;
            border: 2px solid #22c55e;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            text-align: center;
            color: #16a34a;
            font-weight: bold;
            font-size: 16px;
        }
        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .modal.show {
            display: flex;
        }
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }
        .modal-header {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 16px;
            color: #2563eb;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 12px;
        }
        .modal-close {
            float: right;
            font-size: 28px;
            font-weight: bold;
            color: #9ca3af;
            cursor: pointer;
            line-height: 20px;
        }
        .modal-close:hover {
            color: #374151;
        }
        .modal-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .modal-list-item {
            padding: 12px;
            border-bottom: 1px solid #f3f4f6;
            font-size: 16px;
            color: #374151;
        }
        .modal-list-item:last-child {
            border-bottom: none;
        }
        .modal-empty {
            text-align: center;
            color: #9ca3af;
            padding: 20px;
            font-size: 16px;
        }
        
        @media (max-width: 768px) {
            .container { max-width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="app"></div>
    </div>

<script>
    // ãƒ‡ãƒ¼ã‚¿
    let data = {
        name: '', birthday: '', gender: '', bloodType: '', rhFactor: '+', adl: 'independent',
        smoking: 'never', alcohol: 'none',
        address: '', // ä½ã¾ã„
        familyHistory: [], // å®¶æ—æ­´
        emergencyContact: { name: '', phone: '', relationship: '' },
        allergies: [], 
        medicalHistory: [], 
        medications: [], 
        vaccines: [], 
        timeline: [],
        // ç¢ºèªæ¸ˆã¿ãƒ•ãƒ©ã‚°
        allergiesChecked: false,
        medicalHistoryChecked: false,
        medicationsChecked: false,
        familyHistoryChecked: false
    };

    let currentTab = 'summary';
    let editingIndex = null; // ç·¨é›†ä¸­ã®ã‚¢ã‚¤ãƒ†ãƒ ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰èª­ã¿è¾¼ã¿
    const saved = localStorage.getItem('medicalData');
    if (saved) {
        try { 
            const loadedData = JSON.parse(saved);
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¨ãƒãƒ¼ã‚¸ã—ã¦ã€æ–°ã—ã„ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚‚å«ã‚ã‚‹
            data = {
                ...data,
                ...loadedData,
                familyHistory: loadedData.familyHistory || [],
                address: loadedData.address || '',
                birthday: loadedData.birthday || '',
                rhFactor: loadedData.rhFactor || '+',
                allergiesChecked: loadedData.allergiesChecked || false,
                medicalHistoryChecked: loadedData.medicalHistoryChecked || false,
                medicationsChecked: loadedData.medicationsChecked || false,
                familyHistoryChecked: loadedData.familyHistoryChecked || false
            };
            // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®äº’æ›æ€§å‡¦ç†ï¼ˆå¤ã„é¸æŠè‚¢ã‚’æ–°ã—ã„é¸æŠè‚¢ã«å¤‰æ›ï¼‰
            if (data.medicalHistory && data.medicalHistory.length > 0) {
                data.medicalHistory = data.medicalHistory.map(item => {
                    if (item.status === 'æ²»ç™‚ä¸­') item.status = 'é€šé™¢ä¸­';
                    if (item.status === 'æ²»ç™’æ¸ˆã¿') item.status = 'æ²»ç™’çµ‚è¨º';
                    return item;
                });
            }
            // å†…æœè–¬ã®äº’æ›æ€§å‡¦ç†ï¼ˆdosage, frequencyã‚’å‰Šé™¤ã—ã€targetConditionã‚’è¿½åŠ ï¼‰
            if (data.medications && data.medications.length > 0) {
                data.medications = data.medications.map(item => {
                    if (!item.targetCondition) {
                        return {
                            name: item.name,
                            targetCondition: '',
                            hospital: item.hospital || ''
                        };
                    }
                    return item;
                });
            }
            // å®¶æ—æ­´ã®äº’æ›æ€§å‡¦ç†ï¼ˆæ–‡å­—åˆ—å½¢å¼ã‹ã‚‰ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå½¢å¼ã«å¤‰æ›ï¼‰
            if (data.familyHistory && data.familyHistory.length > 0) {
                data.familyHistory = data.familyHistory.map(item => {
                    // æ—¢ã«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå½¢å¼ãªã‚‰ãã®ã¾ã¾
                    if (typeof item === 'object' && item.relationship && item.disease) {
                        return item;
                    }
                    // æ–‡å­—åˆ—å½¢å¼ãªã‚‰å¤‰æ›ï¼ˆä¾‹: "çˆ¶ - ç³–å°¿ç—…" â†’ {relationship: "çˆ¶", disease: "ç³–å°¿ç—…"}ï¼‰
                    if (typeof item === 'string') {
                        const parts = item.split('-').map(p => p.trim());
                        if (parts.length >= 2) {
                            return { relationship: parts[0], disease: parts.slice(1).join('-') };
                        }
                        // ãƒã‚¤ãƒ•ãƒ³ãŒãªã„å ´åˆã¯ãã®ä»–ã§ç™»éŒ²
                        return { relationship: 'ãã®ä»–', disease: item };
                    }
                    return item;
                });
            }
        } catch(e) {}
    }

    // ä¿å­˜
    function save() {
        localStorage.setItem('medicalData', JSON.stringify(data));
        render();
    }

    const adlData = {
        independent: { icon: 'ğŸš¶', label: 'è‡ªç«‹' },
        cane: { icon: 'ğŸ¦¯', label: 'æ–æ­©è¡Œ' },
        wheelchair: { icon: 'â™¿', label: 'è»Šæ¤…å­' },
        bedridden: { icon: 'ğŸ›ï¸', label: 'å¯ãŸãã‚Š' }
    };

    const smokingLabels = { never: 'å–«ç…™æ­´ãªã—', former: 'éå»ã«å–«ç…™', current: 'ç¾åœ¨å–«ç…™ä¸­' };
    const alcoholLabels = { none: 'é£²é…’ãªã—', occasional: 'æ™‚ã€…é£²é…’', daily: 'æ¯æ—¥é£²é…’' };

    // è¨˜å…¥æ¸ˆã¿é …ç›®ã®é€²æ—ã‚’è¨ˆç®—
    function calculateProgress() {
        let total = 0;
        let completed = 0;
        let missing = [];
        
        // åŸºæœ¬æƒ…å ±ï¼ˆ7é …ç›®ï¼‰
        total += 7;
        if (data.birthday) completed++; else missing.push('ç”Ÿå¹´æœˆæ—¥');
        if (data.gender) completed++; else missing.push('æ€§åˆ¥');
        if (data.bloodType) completed++; else missing.push('è¡€æ¶²å‹');
        if (data.address) completed++; else missing.push('ä½ã¾ã„');
        if (data.adl) completed++; else missing.push('ADL');
        if (data.smoking) completed++; else missing.push('å–«ç…™');
        if (data.alcohol) completed++; else missing.push('é£²é…’');
        
        // ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ï¼ˆ1é …ç›®ï¼‰
        total += 1;
        if (data.allergiesChecked || data.allergies.length > 0) completed++; else missing.push('ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼');
        
        // æ—¢å¾€æ­´ï¼ˆ1é …ç›®ï¼‰
        total += 1;
        if (data.medicalHistoryChecked || data.medicalHistory.length > 0) completed++; else missing.push('æ—¢å¾€æ­´');
        
        // å†…æœè–¬ï¼ˆ1é …ç›®ï¼‰
        total += 1;
        if (data.medicationsChecked || data.medications.length > 0) completed++; else missing.push('å†…æœè–¬');
        
        // å®¶æ—æ­´ï¼ˆ1é …ç›®ï¼‰
        total += 1;
        if (data.familyHistoryChecked || (data.familyHistory || []).length > 0) completed++; else missing.push('å®¶æ—æ­´');
        
        const percentage = Math.round((completed / total) * 100);
        return { completed, total, percentage, missing };
    }

    // ç”Ÿå¹´æœˆæ—¥ã‹ã‚‰å¹´é½¢ã‚’è¨ˆç®—
    function calculateAge(birthday) {
        if (!birthday) return '';
        const birthDate = new Date(birthday);
        const today = new Date();
        let age = today.getFullYear() - birthDate.getFullYear();
        const monthDiff = today.getMonth() - birthDate.getMonth();
        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
            age--;
        }
        return age;
    }

    // ã‚µãƒãƒªãƒ¼æ–‡ç« ã‚’ç”Ÿæˆï¼ˆä¸å¯§èªãªã—ï¼‰
    function generateSummaryText() {
        let summary = [];
        
        // ADL
        if (data.adl) {
            if (data.adl !== 'independent') {
                summary.push(`ADL: ${adlData[data.adl].label}`);
            } else {
                summary.push('ADL: è‡ªç«‹');
            }
        }

        // ä½ã¾ã„
        if (data.address) {
            summary.push(data.address);
        }

        // å–«ç…™ãƒ»é£²é…’ï¼ˆå¸¸ã«è¡¨ç¤ºï¼‰
        let habitInfo = [];
        habitInfo.push(smokingLabels[data.smoking] || 'å–«ç…™æ­´ãªã—');
        habitInfo.push(alcoholLabels[data.alcohol] || 'é£²é…’ãªã—');
        if (habitInfo.length > 0) {
            summary.push(habitInfo.join('ã€'));
        }

        return summary;
    }

    function generateMedicalHistorySummary() {
        if (data.medicalHistory.length === 0) {
            if (data.medicalHistoryChecked) {
                return 'ãªã—';
            } else {
                return 'æœªè¨˜è¼‰';
            }
        }
        
        const conditions = data.medicalHistory.map(item => {
            let text = item.condition;
            if (item.hospital) text += `ï¼ˆ${item.hospital}ï¼‰`;
            if (item.hadSurgery) {
                if (item.surgeryType) {
                    text += `ï¼ˆ${item.surgeryType}å¾Œï¼‰`;
                } else {
                    text += `ï¼ˆæ‰‹è¡“å¾Œï¼‰`;
                }
            }
            text += `ï¼ˆ${item.status}ï¼‰`;
            return text;
        });
        
        return conditions.join('<br>');
    }

    function generateMedicationSummary() {
        if (data.medications.length === 0) {
            if (data.medicationsChecked) {
                return 'ãªã—';
            } else {
                return 'æœªè¨˜è¼‰';
            }
        }
        
        const meds = data.medications.map(med => {
            let text = med.name;
            if (med.targetCondition) {
                text += `ï¼ˆ${med.targetCondition}ï¼‰`;
            }
            return text;
        });
        
        return meds.join('ã€');
    }

    function generateFamilyHistorySummary() {
        if ((data.familyHistory || []).length === 0) {
            if (data.familyHistoryChecked) {
                return 'ãªã—';
            } else {
                return 'æœªè¨˜è¼‰';
            }
        }
        const items = data.familyHistory.map(item => {
            if (typeof item === 'object' && item.relationship && item.disease) {
                return `${item.relationship}: ${item.disease}`;
            }
            return item;
        });
        return items.join('<br>');
    }

    function generateAllergySummary() {
        if (data.allergies.length === 0) {
            if (data.allergiesChecked) {
                return 'ãªã—';
            } else {
                return 'æœªè¨˜è¼‰';
            }
        }
        return `<span class="warning-text">âš ï¸ ${data.allergies.join('ã€')}</span>`;
    }

    // ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ†ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    function renderHeader() {
        const age = calculateAge(data.birthday);
        const progress = calculateProgress();

        return `
            <div class="header" style="padding: 16px;">
                <div style="text-align: center; margin-bottom: 12px;">
                    <p style="color: white; font-size: 22px; font-weight: bold;">
                        ${age ? age + 'æ­³' : 'å¹´é½¢æœªç™»éŒ²'}
                        ${data.gender ? ' / ' + data.gender : ''}
                        ${data.bloodType ? ' / ' + data.bloodType + 'å‹' + (data.rhFactor || '+') : ''}
                    </p>
                </div>
                
                <!-- é€²æ—ãƒãƒ¼ -->
                <div style="margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                        <span style="font-size: 12px; color: #bfdbfe;">è¨˜å…¥æ¸ˆã¿</span>
                        <span style="font-size: 12px; color: #bfdbfe; font-weight: bold;">${progress.completed}/${progress.total}é …ç›® (${progress.percentage}%)</span>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); height: 8px; border-radius: 4px; overflow: hidden;">
                        <div style="background: #10b981; height: 100%; width: ${progress.percentage}%; transition: width 0.3s ease;"></div>
                    </div>
                    ${progress.missing.length > 0 ? `
                        <div style="margin-top: 8px; font-size: 11px; color: #fbbf24;">
                            <span style="font-weight: bold;">æœªè¨˜è¼‰ï¼š</span>${progress.missing.join('ã€')}
                        </div>
                    ` : ''}
                </div>
                
                ${data.allergies.length > 0 ? `
                    <div style="background: #fef2f2; border: 2px solid #ef4444; padding: 12px; border-radius: 8px; margin-bottom: 12px; cursor: pointer;" onclick="showAllergiesModal()">
                        <div style="color: #dc2626; font-weight: bold; font-size: 16px; margin-bottom: 4px; text-align: center;">âš ï¸ ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ ${data.allergies.length}ä»¶</div>
                        <div style="color: #991b1b; font-size: 14px; text-align: center;">${data.allergies.join(', ')}</div>
                    </div>
                ` : data.allergiesChecked ? `
                    <div style="background: #f0fdf4; border: 2px solid #22c55e; padding: 12px; border-radius: 8px; margin-bottom: 12px; cursor: pointer;" onclick="showAllergiesModal()">
                        <div style="color: #16a34a; font-weight: bold; font-size: 16px; text-align: center;">âœ“ ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ãªã—</div>
                    </div>
                ` : `
                    <div style="background: #fef9e7; border: 2px solid #f59e0b; padding: 12px; border-radius: 8px; margin-bottom: 12px; cursor: pointer;" onclick="showAllergiesModal()">
                        <div style="color: #d97706; font-weight: bold; font-size: 16px; text-align: center;">âš  ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼æœªè¨˜è¼‰</div>
                    </div>
                `}
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px;">
                    <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 6px; text-align: center; cursor: pointer;" onclick="showMedicalHistoryModal()">
                        <div style="font-size: 11px; opacity: 0.8;">æ—¢å¾€æ­´</div>
                        <div style="font-size: 24px; font-weight: bold;">
                            ${data.medicalHistory.length > 0 ? data.medicalHistory.length + 'ä»¶' : (data.medicalHistoryChecked ? 'ãªã—' : 'æœªè¨˜è¼‰')}
                        </div>
                    </div>
                    <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 6px; text-align: center; cursor: pointer;" onclick="showMedicationsModal()">
                        <div style="font-size: 11px; opacity: 0.8;">å†…æœè–¬</div>
                        <div style="font-size: 24px; font-weight: bold;">
                            ${data.medications.length > 0 ? data.medications.length + 'å‰¤' : (data.medicationsChecked ? 'ãªã—' : 'æœªè¨˜è¼‰')}
                        </div>
                    </div>
                    <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 6px; text-align: center; cursor: pointer;" onclick="showFamilyHistoryModal()">
                        <div style="font-size: 11px; opacity: 0.8;">å®¶æ—æ­´</div>
                        <div style="font-size: 24px; font-weight: bold;">
                            ${(data.familyHistory || []).length > 0 ? (data.familyHistory || []).length + 'ä»¶' : (data.familyHistoryChecked ? 'ãªã—' : 'æœªè¨˜è¼‰')}
                        </div>
                    </div>
                    <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 6px; text-align: center;">
                        <div style="font-size: 11px; opacity: 0.8;">ADL</div>
                        <div style="font-size: 24px; font-weight: bold;">${adlData[data.adl].label}</div>
                    </div>
                </div>
            </div>
        `;
    }

    // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„éƒ¨åˆ†ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    function renderContent() {
        if (currentTab === 'summary') {
            const basicSummary = generateSummaryText();
            const medicalSummary = generateMedicalHistorySummary();
            const medicationSummary = generateMedicationSummary();
            const familySummary = generateFamilyHistorySummary();
            const allergySummary = generateAllergySummary();
            
            let hasAnyData = data.birthday || data.gender || data.bloodType || 
                             data.address || data.allergies.length > 0 || data.medicalHistory.length > 0 || 
                             data.medications.length > 0 || (data.familyHistory || []).length > 0 ||
                             data.allergiesChecked || data.medicalHistoryChecked || 
                             data.medicationsChecked || data.familyHistoryChecked;

            return `
                <div class="card" style="margin: 8px;">
                    ${!hasAnyData ? `
                        <div style="text-align: center; padding: 20px; color: #9ca3af;">
                            <p>ã¾ã æƒ…å ±ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
                            <p style="margin-top: 8px; font-size: 14px;">ä¸Šã®ã‚¿ãƒ–ã‹ã‚‰å„é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
                        </div>
                    ` : `
                        <div class="summary-text">
                            <div class="summary-section">
                                <div class="summary-section-title">â–  æ—¢å¾€æ­´</div>
                                <div>${medicalSummary}</div>
                            </div>

                            <div class="summary-section">
                                <div class="summary-section-title">â–  å†…æœè–¬</div>
                                <div>${medicationSummary}</div>
                            </div>

                            <div class="summary-section">
                                <div class="summary-section-title">â–  å®¶æ—æ­´</div>
                                <div>${familySummary}</div>
                            </div>

                            <div class="summary-section">
                                <div class="summary-section-title">â–  ç”Ÿæ´»æ­´</div>
                                <div>${basicSummary.join(' / ')}</div>
                            </div>

                            <div class="summary-section">
                                <div class="summary-section-title">â–  ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼</div>
                                <div>${allergySummary}</div>
                            </div>
                        </div>
                    `}
                </div>
            `;
        }

        if (currentTab === 'basic') {
            const age = calculateAge(data.birthday);
            
            return `
                <div class="card" style="margin: 8px;">
                    <h2 style="color: #2563eb;">åŸºæœ¬æƒ…å ±</h2>
                    <h3>ç”Ÿå¹´æœˆæ—¥</h3>
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 8px;">
                        <select id="birthYear" onchange="updateBirthday()">
                            <option value="">å¹´</option>
                            ${(() => {
                                const currentYear = new Date().getFullYear();
                                const years = [];
                                for (let y = currentYear; y >= 1900; y--) {
                                    const birthYear = data.birthday ? new Date(data.birthday).getFullYear() : null;
                                    years.push(`<option value="${y}" ${birthYear === y ? 'selected' : ''}>${y}å¹´</option>`);
                                }
                                return years.join('');
                            })()}
                        </select>
                        <select id="birthMonth" onchange="updateBirthday()">
                            <option value="">æœˆ</option>
                            ${(() => {
                                const months = [];
                                for (let m = 1; m <= 12; m++) {
                                    const birthMonth = data.birthday ? new Date(data.birthday).getMonth() + 1 : null;
                                    months.push(`<option value="${m}" ${birthMonth === m ? 'selected' : ''}>${m}æœˆ</option>`);
                                }
                                return months.join('');
                            })()}
                        </select>
                        <select id="birthDay" onchange="updateBirthday()">
                            <option value="">æ—¥</option>
                            ${(() => {
                                const days = [];
                                for (let d = 1; d <= 31; d++) {
                                    const birthDay = data.birthday ? new Date(data.birthday).getDate() : null;
                                    days.push(`<option value="${d}" ${birthDay === d ? 'selected' : ''}>${d}æ—¥</option>`);
                                }
                                return days.join('');
                            })()}
                        </select>
                    </div>
                    ${age ? `<div style="font-size: 14px; color: #2563eb; margin-top: 8px; text-align: center; font-weight: bold;">ç¾åœ¨ ${age}æ­³</div>` : ''}
                    
                    <h3 style="margin-top: 16px;">æ€§åˆ¥ãƒ»è¡€æ¶²å‹</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
                        <select onchange="data.gender=this.value; save()">
                            <option value="">æ€§åˆ¥</option>
                            <option value="ç”·æ€§" ${data.gender === 'ç”·æ€§' ? 'selected' : ''}>ç”·æ€§</option>
                            <option value="å¥³æ€§" ${data.gender === 'å¥³æ€§' ? 'selected' : ''}>å¥³æ€§</option>
                        </select>
                        <select onchange="data.bloodType=this.value; save()">
                            <option value="">è¡€æ¶²å‹</option>
                            <option value="A" ${data.bloodType === 'A' ? 'selected' : ''}>Aå‹</option>
                            <option value="B" ${data.bloodType === 'B' ? 'selected' : ''}>Bå‹</option>
                            <option value="O" ${data.bloodType === 'O' ? 'selected' : ''}>Oå‹</option>
                            <option value="AB" ${data.bloodType === 'AB' ? 'selected' : ''}>ABå‹</option>
                        </select>
                        <select onchange="data.rhFactor=this.value; save()">
                            <option value="+">Rh(+)</option>
                            <option value="-" ${data.rhFactor === '-' ? 'selected' : ''}>Rh(-)</option>
                        </select>
                    </div>

                    <h3>ä½ã¾ã„</h3>
                    <select onchange="data.address=this.value; save()">
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        <option value="è‡ªå®…ï¼ˆç‹¬å±…ï¼‰" ${data.address === 'è‡ªå®…ï¼ˆç‹¬å±…ï¼‰' ? 'selected' : ''}>è‡ªå®…ï¼ˆç‹¬å±…ï¼‰</option>
                        <option value="è‡ªå®…ï¼ˆå®¶æ—ã¨åŒå±…ï¼‰" ${data.address === 'è‡ªå®…ï¼ˆå®¶æ—ã¨åŒå±…ï¼‰' ? 'selected' : ''}>è‡ªå®…ï¼ˆå®¶æ—ã¨åŒå±…ï¼‰</option>
                        <option value="è€äººãƒ›ãƒ¼ãƒ " ${data.address === 'è€äººãƒ›ãƒ¼ãƒ ' ? 'selected' : ''}>è€äººãƒ›ãƒ¼ãƒ </option>
                        <option value="ã‚°ãƒ«ãƒ¼ãƒ—ãƒ›ãƒ¼ãƒ " ${data.address === 'ã‚°ãƒ«ãƒ¼ãƒ—ãƒ›ãƒ¼ãƒ ' ? 'selected' : ''}>ã‚°ãƒ«ãƒ¼ãƒ—ãƒ›ãƒ¼ãƒ </option>
                        <option value="ã‚µãƒ¼ãƒ“ã‚¹ä»˜ãé«˜é½¢è€…å‘ã‘ä½å®…" ${data.address === 'ã‚µãƒ¼ãƒ“ã‚¹ä»˜ãé«˜é½¢è€…å‘ã‘ä½å®…' ? 'selected' : ''}>ã‚µãƒ¼ãƒ“ã‚¹ä»˜ãé«˜é½¢è€…å‘ã‘ä½å®…</option>
                        <option value="ç‰¹åˆ¥é¤Šè­·è€äººãƒ›ãƒ¼ãƒ " ${data.address === 'ç‰¹åˆ¥é¤Šè­·è€äººãƒ›ãƒ¼ãƒ ' ? 'selected' : ''}>ç‰¹åˆ¥é¤Šè­·è€äººãƒ›ãƒ¼ãƒ </option>
                        <option value="ä»‹è­·è€äººä¿å¥æ–½è¨­" ${data.address === 'ä»‹è­·è€äººä¿å¥æ–½è¨­' ? 'selected' : ''}>ä»‹è­·è€äººä¿å¥æ–½è¨­</option>
                        <option value="ç—…é™¢ãƒ»ç™‚é¤Šæ–½è¨­" ${data.address === 'ç—…é™¢ãƒ»ç™‚é¤Šæ–½è¨­' ? 'selected' : ''}>ç—…é™¢ãƒ»ç™‚é¤Šæ–½è¨­</option>
                    </select>

                    <h3>ADLï¼ˆæ—¥å¸¸ç”Ÿæ´»å‹•ä½œï¼‰</h3>
                    <div class="adl-grid">
                        ${Object.entries(adlData).map(([key, value]) => `
                            <div class="adl-button ${data.adl === key ? 'selected' : ''}" onclick="data.adl='${key}'; save()">
                                <div class="icon">${value.icon}</div>
                                <div class="label">${value.label}</div>
                            </div>
                        `).join('')}
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <select onchange="data.smoking=this.value; save()">
                            <option value="never" ${data.smoking === 'never' ? 'selected' : ''}>å–«ç…™æ­´ãªã—</option>
                            <option value="former" ${data.smoking === 'former' ? 'selected' : ''}>éå»ã«å–«ç…™</option>
                            <option value="current" ${data.smoking === 'current' ? 'selected' : ''}>ç¾åœ¨å–«ç…™ä¸­</option>
                        </select>
                        <select onchange="data.alcohol=this.value; save()">
                            <option value="none" ${data.alcohol === 'none' ? 'selected' : ''}>é£²é…’ãªã—</option>
                            <option value="occasional" ${data.alcohol === 'occasional' ? 'selected' : ''}>æ™‚ã€…é£²é…’</option>
                            <option value="daily" ${data.alcohol === 'daily' ? 'selected' : ''}>æ¯æ—¥é£²é…’</option>
                        </select>
                    </div>
                </div>
            `;
        }

        if (currentTab === 'history') {
            const isEditing = editingIndex !== null;
            const currentItem = isEditing ? data.medicalHistory[editingIndex] : null;
            const showSurgeryType = isEditing ? currentItem?.hadSurgery : false;
            
            let html = `
                <div class="card" style="margin: 8px;">
                    <h2 style="color: #2563eb;">æ—¢å¾€æ­´</h2>
            `;
            
            // ã€Œãªã—ã€ç™»éŒ²æ¸ˆã¿ã®è¡¨ç¤º
            if (data.medicalHistoryChecked && data.medicalHistory.length === 0) {
                html += `
                    <div style="padding: 16px; color: #1f2937; font-size: 20px; font-weight: 600;">
                        ãªã—
                    </div>
                `;
            }
            
            // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®ã¨ãã¯ãƒ•ã‚©ãƒ¼ãƒ ã‚’å…ˆã«è¡¨ç¤º
            if (isEditing) {
                html += `
                    <h3>æ—¢å¾€æ­´ã‚’ç·¨é›†</h3>
                    <input type="text" id="newCondition" placeholder="ç—…åï¼ˆä¾‹: é«˜è¡€åœ§ï¼‰" value="${isEditing ? currentItem.condition : ''}" style="font-size: 18px;">
                    <input type="text" id="newConditionAge" placeholder="ç™ºç—‡å¹´é½¢ï¼ˆä¾‹: 65ï¼‰" value="${isEditing && currentItem?.ageAtOnset ? currentItem.ageAtOnset : ''}" style="font-size: 18px;">
                    <select id="newConditionStatus" style="font-size: 18px;">
                        <option value="">çŠ¶æ…‹ã‚’é¸æŠ</option>
                        <option value="æœªæ²»ç™‚" ${isEditing && currentItem?.status === 'æœªæ²»ç™‚' ? 'selected' : ''}>æœªæ²»ç™‚</option>
                        <option value="é€šé™¢ä¸­" ${isEditing && currentItem?.status === 'é€šé™¢ä¸­' ? 'selected' : ''}>é€šé™¢ä¸­</option>
                        <option value="åŒ–å­¦ç™‚æ³•ä¸­" ${isEditing && currentItem?.status === 'åŒ–å­¦ç™‚æ³•ä¸­' ? 'selected' : ''}>åŒ–å­¦ç™‚æ³•ä¸­</option>
                        <option value="æ²»ç™‚ä¸­æ–­" ${isEditing && currentItem?.status === 'æ²»ç™‚ä¸­æ–­' ? 'selected' : ''}>æ²»ç™‚ä¸­æ–­</option>
                        <option value="å¤–æ¥çµŒéè¦³å¯Ÿä¸­" ${isEditing && currentItem?.status === 'å¤–æ¥çµŒéè¦³å¯Ÿä¸­' ? 'selected' : ''}>å¤–æ¥çµŒéè¦³å¯Ÿä¸­</option>
                        <option value="æ²»ç™’çµ‚è¨º" ${isEditing && currentItem?.status === 'æ²»ç™’çµ‚è¨º' ? 'selected' : ''}>æ²»ç™’çµ‚è¨º</option>
                    </select>
                    <input type="text" id="newConditionHospital" placeholder="ã‹ã‹ã‚Šã¤ã‘ï¼ˆä¾‹: â—‹â—‹ç—…é™¢ï¼‰" value="${isEditing ? (currentItem.hospital || '') : ''}" style="font-size: 18px;">
                    <div style="margin: 8px 0;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="newConditionSurgery" style="width: auto; margin-right: 8px;" ${isEditing && currentItem?.hadSurgery ? 'checked' : ''}>
                            <span style="font-size: 18px;">æ‰‹è¡“æ­´ã‚ã‚Š</span>
                        </label>
                    </div>
                    <input type="text" id="newConditionSurgeryType" placeholder="è¡“å¼ï¼ˆä¾‹: å† å‹•è„ˆãƒã‚¤ãƒ‘ã‚¹è¡“ï¼‰" value="${isEditing ? (currentItem.surgeryType || '') : ''}" 
                        style="${showSurgeryType ? '' : 'display:none;'} font-size: 18px;">
                    <div class="flex-row">
                        <button class="button" onclick="updateHistory()">æ›´æ–°</button>
                        <button class="button" style="background: #6b7280;" onclick="cancelEdit()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    </div>
                `;
            } else {
                html += `<div style="margin-top: 16px;"></div>`;
            }
            
            if (data.medicalHistory.length > 0) {
                data.medicalHistory.forEach((item, i) => {
                    // ãƒãƒƒã‚¸ã®è‰²åˆ†ã‘
                    let badgeClass = 'badge-inactive';
                    if (item.status === 'é€šé™¢ä¸­' || item.status === 'åŒ–å­¦ç™‚æ³•ä¸­') {
                        badgeClass = 'badge-active';
                    } else if (item.status === 'æœªæ²»ç™‚' || item.status === 'æ²»ç™‚ä¸­æ–­') {
                        badgeClass = 'badge-warning';
                    } else if (item.status === 'å¤–æ¥çµŒéè¦³å¯Ÿä¸­') {
                        badgeClass = 'badge-observation';
                    }
                    
                    html += `
                        <div class="list-item" style="display: flex; justify-content: space-between; align-items: start; ${editingIndex === i ? 'background: #eff6ff; border: 2px solid #2563eb;' : ''}">
                            <div style="flex: 1;">
                                <div>
                                    <span style="font-weight: 600; font-size: 18px;">${item.condition}</span>
                                    ${item.ageAtOnset ? `<span style="font-size: 16px; color: #6b7280; margin-left: 8px;">${item.ageAtOnset}æ­³æ™‚</span>` : ''}
                                    <span class="badge ${badgeClass}" style="margin-left: 8px; font-size: 14px;">${item.status}</span>
                                </div>
                                ${item.hadSurgery ? `<div style="font-size: 16px; color: #dc2626; margin-top: 6px;">âœ“ æ‰‹è¡“æ­´ã‚ã‚Š${item.surgeryType ? 'ï¼š' + item.surgeryType : ''}</div>` : ''}
                                ${item.hospital ? `<div style="font-size: 16px; color: #6b7280; margin-top: 6px;">ã‹ã‹ã‚Šã¤ã‘ï¼š${item.hospital}</div>` : ''}
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <span class="delete-btn" style="color: #2563eb; font-size: 15px;" onclick="editHistory(${i})">ç·¨é›†</span>
                                <span class="delete-btn" style="font-size: 15px;" onclick="removeHistory(${i})">å‰Šé™¤</span>
                            </div>
                        </div>
                    `;
                });
            }
            
            // æ–°è¦è¿½åŠ ãƒ¢ãƒ¼ãƒ‰ã®ã¨ãã¯ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä¸‹ã«è¡¨ç¤º
            if (!isEditing) {
                html += `
                    <h3 style="margin-top: 24px;">æ–°ã—ã„æ—¢å¾€æ­´ã‚’è¿½åŠ </h3>
                    <input type="text" id="newCondition" placeholder="ç—…åï¼ˆä¾‹: é«˜è¡€åœ§ï¼‰" style="font-size: 18px;">
                    <input type="text" id="newConditionAge" placeholder="ç™ºç—‡å¹´é½¢ï¼ˆä¾‹: 65ï¼‰" style="font-size: 18px;">
                    <select id="newConditionStatus" style="font-size: 18px;">
                        <option value="">çŠ¶æ…‹ã‚’é¸æŠ</option>
                        <option value="æœªæ²»ç™‚">æœªæ²»ç™‚</option>
                        <option value="é€šé™¢ä¸­">é€šé™¢ä¸­</option>
                        <option value="åŒ–å­¦ç™‚æ³•ä¸­">åŒ–å­¦ç™‚æ³•ä¸­</option>
                        <option value="æ²»ç™‚ä¸­æ–­">æ²»ç™‚ä¸­æ–­</option>
                        <option value="å¤–æ¥çµŒéè¦³å¯Ÿä¸­">å¤–æ¥çµŒéè¦³å¯Ÿä¸­</option>
                        <option value="æ²»ç™’çµ‚è¨º">æ²»ç™’çµ‚è¨º</option>
                    </select>
                    <input type="text" id="newConditionHospital" placeholder="ã‹ã‹ã‚Šã¤ã‘ï¼ˆä¾‹: â—‹â—‹ç—…é™¢ï¼‰" style="font-size: 18px;">
                    <div style="margin: 8px 0;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="newConditionSurgery" style="width: auto; margin-right: 8px;">
                            <span style="font-size: 18px;">æ‰‹è¡“æ­´ã‚ã‚Š</span>
                        </label>
                    </div>
                    <input type="text" id="newConditionSurgeryType" placeholder="è¡“å¼ï¼ˆä¾‹: å† å‹•è„ˆãƒã‚¤ãƒ‘ã‚¹è¡“ï¼‰" style="display:none; font-size: 18px;">
                    <div class="flex-row">
                        <button class="button" onclick="addHistory()">è¿½åŠ </button>
                    </div>
                    ${data.medicalHistory.length === 0 && !data.medicalHistoryChecked ? `
                        <div style="margin-top: 16px; text-align: center;">
                            <button class="button" style="background: #22c55e; width: 100%;" onclick="setMedicalHistoryNone()">
                                âœ“ æ—¢å¾€æ­´ãªã—ã¨ç™»éŒ²
                            </button>
                        </div>
                    ` : ''}
                `;
            }
            
            html += `</div>`;
            return html;
        }

        if (currentTab === 'medications') {
            const isEditing = editingIndex !== null;
            
            let html = `<div class="card" style="margin: 8px;"><h2 style="color: #2563eb;">å†…æœè–¬</h2>`;
            
            // ã€Œãªã—ã€ç™»éŒ²æ¸ˆã¿ã®è¡¨ç¤º
            if (data.medicationsChecked && data.medications.length === 0) {
                html += `
                    <div style="padding: 16px; color: #1f2937; font-size: 20px; font-weight: 600;">
                        ãªã—
                    </div>
                `;
            }
            
            // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®ã¨ãã¯ãƒ•ã‚©ãƒ¼ãƒ ã‚’å…ˆã«è¡¨ç¤º
            if (isEditing) {
                // æ—¢å¾€æ­´ã‹ã‚‰ç–¾æ‚£ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ
                const conditionOptions = data.medicalHistory.map(item => 
                    `<option value="${item.condition}" ${isEditing && data.medications[editingIndex] && data.medications[editingIndex].targetCondition === item.condition ? 'selected' : ''}>${item.condition}</option>`
                ).join('');
                
                html += `
                    <h3>å†…æœè–¬ã‚’ç·¨é›†</h3>
                    <input type="text" id="medName" placeholder="è–¬å" value="${isEditing && data.medications[editingIndex] ? data.medications[editingIndex].name : ''}">
                    <select id="medTargetCondition" style="font-size: 18px;">
                        <option value="">å¯¾è±¡ç–¾æ‚£ã‚’é¸æŠï¼ˆä»»æ„ï¼‰</option>
                        ${conditionOptions}
                    </select>
                    ${data.medicalHistory.length === 0 ? '<div style="font-size: 14px; color: #9ca3af; margin: 8px 0;">â€»æ—¢å¾€æ­´ã‚’ç™»éŒ²ã™ã‚‹ã¨å¯¾è±¡ç–¾æ‚£ã‚’é¸æŠã§ãã¾ã™</div>' : ''}
                    <input type="text" id="medHospital" placeholder="å‡¦æ–¹å…ƒï¼ˆä¾‹: â—‹â—‹ç—…é™¢ï¼‰" value="${isEditing && data.medications[editingIndex] ? data.medications[editingIndex].hospital : ''}">
                    <div class="flex-row">
                        <button class="button" onclick="updateMedication()">æ›´æ–°</button>
                        <button class="button" style="background: #6b7280;" onclick="cancelEdit()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    </div>
                `;
            } else {
                html += `<div style="margin-top: 16px;"></div>`;
            }
            
            if (data.medications.length > 0) {
                data.medications.forEach((med, i) => {
                    html += `
                        <div class="list-item" style="${editingIndex === i ? 'background: #eff6ff; border: 2px solid #2563eb;' : ''}">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div style="flex: 1;">
                                    <div style="font-weight: bold; font-size: 16px;">${med.name}</div>
                                    ${med.targetCondition ? `<div style="font-size: 14px; color: #6b7280; margin-top: 4px;">å¯¾è±¡ç–¾æ‚£: ${med.targetCondition}</div>` : ''}
                                    ${med.hospital ? `<div style="font-size: 14px; color: #9ca3af;">å‡¦æ–¹å…ƒ: ${med.hospital}</div>` : ''}
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <span class="delete-btn" style="color: #2563eb;" onclick="editMedication(${i})">ç·¨é›†</span>
                                    <span class="delete-btn" onclick="removeMedication(${i})">å‰Šé™¤</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }

            // æ–°è¦è¿½åŠ ãƒ¢ãƒ¼ãƒ‰ã®ã¨ãã¯ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä¸‹ã«è¡¨ç¤º
            if (!isEditing) {
                // æ—¢å¾€æ­´ã‹ã‚‰ç–¾æ‚£ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ
                const conditionOptions = data.medicalHistory.map(item => 
                    `<option value="${item.condition}">${item.condition}</option>`
                ).join('');
                
                html += `
                    <h3 style="margin-top: 24px;">æ–°ã—ã„å†…æœè–¬ã‚’è¿½åŠ </h3>
                    <input type="text" id="medName" placeholder="è–¬å">
                    <select id="medTargetCondition" style="font-size: 18px;">
                        <option value="">å¯¾è±¡ç–¾æ‚£ã‚’é¸æŠï¼ˆä»»æ„ï¼‰</option>
                        ${conditionOptions}
                    </select>
                    ${data.medicalHistory.length === 0 ? '<div style="font-size: 14px; color: #9ca3af; margin: 8px 0;">â€»æ—¢å¾€æ­´ã‚’ç™»éŒ²ã™ã‚‹ã¨å¯¾è±¡ç–¾æ‚£ã‚’é¸æŠã§ãã¾ã™</div>' : ''}
                    <input type="text" id="medHospital" placeholder="å‡¦æ–¹å…ƒï¼ˆä¾‹: â—‹â—‹ç—…é™¢ï¼‰">
                    <div class="flex-row">
                        <button class="button" onclick="addMedication()">è¿½åŠ </button>
                    </div>
                    ${data.medications.length === 0 && !data.medicationsChecked ? `
                        <div style="margin-top: 16px; text-align: center;">
                            <button class="button" style="background: #22c55e; width: 100%;" onclick="setMedicationsNone()">
                                âœ“ å†…æœè–¬ãªã—ã¨ç™»éŒ²
                            </button>
                        </div>
                    ` : ''}
                `;
            }
            
            html += `</div>`;
            return html;
        }

        if (currentTab === 'family') {
            let html = `
                <div class="card" style="margin: 8px;">
                    <h2 style="color: #2563eb;">å®¶æ—æ­´</h2>
            `;
            
            // ã€Œãªã—ã€ç™»éŒ²æ¸ˆã¿ã®è¡¨ç¤º
            if (data.familyHistoryChecked && (data.familyHistory || []).length === 0) {
                html += `
                    <div style="padding: 16px; color: #1f2937; font-size: 20px; font-weight: 600;">
                        ãªã—
                    </div>
                `;
            }

            if ((data.familyHistory || []).length > 0) {
                data.familyHistory.forEach((item, i) => {
                    const displayText = typeof item === 'object' && item.relationship && item.disease 
                        ? `${item.relationship} - ${item.disease}`
                        : item;
                    html += `
                        <div class="list-item" style="display: flex; justify-content: space-between; align-items: center;">
                            <span>${displayText}</span>
                            <span class="delete-btn" onclick="removeFamilyHistory(${i})">å‰Šé™¤</span>
                        </div>
                    `;
                });
            }

            html += `
                    <h3 style="margin-top: 24px;">æ–°ã—ã„å®¶æ—æ­´ã‚’è¿½åŠ </h3>
                    <select id="newFamilyRelationship" style="font-size: 18px;">
                        <option value="">ç¶šæŸ„ã‚’é¸æŠ</option>
                        <option value="çˆ¶">çˆ¶</option>
                        <option value="æ¯">æ¯</option>
                        <option value="ç¥–çˆ¶ï¼ˆçˆ¶æ–¹ï¼‰">ç¥–çˆ¶ï¼ˆçˆ¶æ–¹ï¼‰</option>
                        <option value="ç¥–æ¯ï¼ˆçˆ¶æ–¹ï¼‰">ç¥–æ¯ï¼ˆçˆ¶æ–¹ï¼‰</option>
                        <option value="ç¥–çˆ¶ï¼ˆæ¯æ–¹ï¼‰">ç¥–çˆ¶ï¼ˆæ¯æ–¹ï¼‰</option>
                        <option value="ç¥–æ¯ï¼ˆæ¯æ–¹ï¼‰">ç¥–æ¯ï¼ˆæ¯æ–¹ï¼‰</option>
                        <option value="å…„">å…„</option>
                        <option value="å§‰">å§‰</option>
                        <option value="å¼Ÿ">å¼Ÿ</option>
                        <option value="å¦¹">å¦¹</option>
                        <option value="å­">å­</option>
                        <option value="ãã®ä»–">ãã®ä»–</option>
                    </select>
                    <input type="text" id="newFamilyDisease" placeholder="ç—…åï¼ˆä¾‹: ç³–å°¿ç—…ï¼‰" style="font-size: 18px;">
                    <button class="button" onclick="addFamilyHistory()">è¿½åŠ </button>
                    ${(data.familyHistory || []).length === 0 && !data.familyHistoryChecked ? `
                        <div style="margin-top: 16px; text-align: center;">
                            <button class="button" style="background: #22c55e; width: 100%;" onclick="setFamilyHistoryNone()">
                                âœ“ å®¶æ—æ­´ãªã—ã¨ç™»éŒ²
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
            
            return html;
        }

        if (currentTab === 'allergies') {
            const isEditing = editingIndex !== null;
            
            let html = `<div class="card" style="margin: 8px;"><h2 style="color: #2563eb;">ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼</h2>`;
            
            // ã€Œãªã—ã€ç™»éŒ²æ¸ˆã¿ã®è¡¨ç¤º
            if (data.allergiesChecked && data.allergies.length === 0) {
                html += `
                    <div style="padding: 16px; color: #1f2937; font-size: 20px; font-weight: 600;">
                        ãªã—
                    </div>
                `;
            }
            
            // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®ã¨ãã¯ãƒ•ã‚©ãƒ¼ãƒ ã‚’å…ˆã«è¡¨ç¤º
            if (isEditing) {
                html += `
                    <h3>${isEditing ? 'ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ã‚’ç·¨é›†' : 'æ–°ã—ã„ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ã‚’è¿½åŠ '}</h3>
                    <div class="flex-row">
                        <input type="text" id="newAllergy" placeholder="ä¾‹: ãƒšãƒ‹ã‚·ãƒªãƒ³" value="${isEditing && data.allergies[editingIndex] ? data.allergies[editingIndex] : ''}">
                        <button class="button" style="width: auto;" onclick="${isEditing ? 'updateAllergy()' : 'addAllergy()'}">
                            ${isEditing ? 'æ›´æ–°' : 'è¿½åŠ '}
                        </button>
                        ${isEditing ? '<button class="button" style="width: auto; background: #6b7280;" onclick="cancelEdit()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>' : ''}
                    </div>
                `;
            } else {
                html += `<div style="margin-top: 16px;"></div>`;
            }
            
            if (data.allergies.length > 0) {
                data.allergies.forEach((allergy, i) => {
                    html += `
                        <div class="list-item" style="display: flex; justify-content: space-between; align-items: center; background: #fef2f2; ${editingIndex === i ? 'border: 2px solid #2563eb;' : ''}">
                            <span style="color: #991b1b; font-weight: 500;">${allergy}</span>
                            <div style="display: flex; gap: 8px;">
                                <span class="delete-btn" style="color: #2563eb;" onclick="editAllergy(${i})">ç·¨é›†</span>
                                <span class="delete-btn" onclick="removeAllergy(${i})">å‰Šé™¤</span>
                            </div>
                        </div>
                    `;
                });
            }

            // æ–°è¦è¿½åŠ ãƒ¢ãƒ¼ãƒ‰ã®ã¨ãã¯ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä¸‹ã«è¡¨ç¤º
            if (!isEditing) {
                html += `
                    <h3 style="margin-top: 24px;">æ–°ã—ã„ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ã‚’è¿½åŠ </h3>
                    <div class="flex-row">
                        <input type="text" id="newAllergy" placeholder="ä¾‹: ãƒšãƒ‹ã‚·ãƒªãƒ³">
                        <button class="button" style="width: auto;" onclick="addAllergy()">è¿½åŠ </button>
                    </div>
                    ${data.allergies.length === 0 && !data.allergiesChecked ? `
                        <div style="margin-top: 16px; text-align: center;">
                            <button class="button" style="background: #22c55e; width: 100%;" onclick="setAllergiesNone()">
                                âœ“ ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ãªã—ã¨ç™»éŒ²
                            </button>
                        </div>
                    ` : ''}
                `;
            }
            
            html += `</div>`;
            return html;
        }

        return '';
    }

    // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    function render() {
        const app = document.getElementById('app');
        app.innerHTML = `
            ${renderHeader()}
            <div class="card tab-container">
                <button class="tab ${currentTab === 'summary' ? 'active' : ''}" onclick="switchTab('summary')">ã‚µãƒãƒªãƒ¼</button>
                <button class="tab ${currentTab === 'basic' ? 'active' : ''}" onclick="switchTab('basic')">åŸºæœ¬æƒ…å ±</button>
                <button class="tab ${currentTab === 'history' ? 'active' : ''}" onclick="switchTab('history')">æ—¢å¾€æ­´</button>
                <button class="tab ${currentTab === 'medications' ? 'active' : ''}" onclick="switchTab('medications')">å†…æœè–¬</button>
                <button class="tab ${currentTab === 'family' ? 'active' : ''}" onclick="switchTab('family')">å®¶æ—æ­´</button>
                <button class="tab ${currentTab === 'allergies' ? 'active' : ''}" onclick="switchTab('allergies')">ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼</button>
            </div>
            ${renderContent()}
        `;
    }

    // æ“ä½œé–¢æ•°
    function switchTab(tab) {
        currentTab = tab;
        editingIndex = null;
        render();
    }

    function addAllergy() {
        const input = document.getElementById('newAllergy');
        if (input.value.trim() && !data.allergies.includes(input.value.trim())) {
            data.allergies.push(input.value.trim());
            data.allergiesChecked = true;
            save();
        }
    }

    function editAllergy(index) {
        editingIndex = index;
        render();
    }

    function updateAllergy() {
        if (editingIndex !== null) {
            const input = document.getElementById('newAllergy');
            if (input.value.trim()) {
                data.allergies[editingIndex] = input.value.trim();
                editingIndex = null;
                save();
            }
        }
    }

    function removeAllergy(index) {
        data.allergies.splice(index, 1);
        if (editingIndex === index) editingIndex = null;
        save();
    }

    function addHistory() {
        const condition = document.getElementById('newCondition').value.trim();
        const ageAtOnset = document.getElementById('newConditionAge').value;
        const status = document.getElementById('newConditionStatus').value;
        const hospital = document.getElementById('newConditionHospital').value.trim();
        const hadSurgery = document.getElementById('newConditionSurgery').checked;
        const surgeryType = document.getElementById('newConditionSurgeryType').value.trim();
        if (condition) {
            data.medicalHistory.push({ condition, ageAtOnset, status, hospital, hadSurgery, surgeryType });
            data.medicalHistoryChecked = true;
            save();
        }
    }

    function editHistory(index) {
        editingIndex = index;
        render();
    }

    function updateHistory() {
        if (editingIndex !== null) {
            const condition = document.getElementById('newCondition').value.trim();
            const ageAtOnset = document.getElementById('newConditionAge').value;
            const status = document.getElementById('newConditionStatus').value;
            const hospital = document.getElementById('newConditionHospital').value.trim();
            const hadSurgery = document.getElementById('newConditionSurgery').checked;
            const surgeryType = document.getElementById('newConditionSurgeryType').value.trim();
            if (condition) {
                data.medicalHistory[editingIndex] = { condition, ageAtOnset, status, hospital, hadSurgery, surgeryType };
                editingIndex = null;
                save();
            }
        }
    }

    function cancelEdit() {
        editingIndex = null;
        render();
    }

    function removeHistory(index) {
        data.medicalHistory.splice(index, 1);
        if (editingIndex === index) editingIndex = null;
        save();
    }

    function addMedication() {
        const name = document.getElementById('medName').value.trim();
        const targetCondition = document.getElementById('medTargetCondition').value;
        const hospital = document.getElementById('medHospital').value.trim();
        if (name) {
            data.medications.push({ name, targetCondition, hospital });
            data.medicationsChecked = true;
            save();
        }
    }

    function editMedication(index) {
        editingIndex = index;
        render();
    }

    function updateMedication() {
        if (editingIndex !== null) {
            const name = document.getElementById('medName').value.trim();
            const targetCondition = document.getElementById('medTargetCondition').value;
            const hospital = document.getElementById('medHospital').value.trim();
            if (name) {
                data.medications[editingIndex] = { name, targetCondition, hospital };
                editingIndex = null;
                save();
            }
        }
    }

    function removeMedication(index) {
        data.medications.splice(index, 1);
        if (editingIndex === index) editingIndex = null;
        save();
    }

    function addFamilyHistory() {
        const relationship = document.getElementById('newFamilyRelationship').value;
        const disease = document.getElementById('newFamilyDisease').value.trim();
        if (relationship && disease) {
            if (!data.familyHistory) data.familyHistory = [];
            data.familyHistory.push({ relationship, disease });
            data.familyHistoryChecked = true;
            save();
        }
    }

    function removeFamilyHistory(index) {
        if (!data.familyHistory) data.familyHistory = [];
        data.familyHistory.splice(index, 1);
        save();
    }

    function updateBirthday() {
        const year = document.getElementById('birthYear')?.value;
        const month = document.getElementById('birthMonth')?.value;
        const day = document.getElementById('birthDay')?.value;
        
        if (year && month && day) {
            data.birthday = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            save();
        }
    }

    function setAllergiesNone() {
        data.allergiesChecked = true;
        data.allergies = [];
        save();
    }

    function setMedicalHistoryNone() {
        data.medicalHistoryChecked = true;
        data.medicalHistory = [];
        save();
    }

    function setMedicationsNone() {
        data.medicationsChecked = true;
        data.medications = [];
        save();
    }

    function setFamilyHistoryNone() {
        data.familyHistoryChecked = true;
        data.familyHistory = [];
        save();
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºé–¢æ•°
    function showAllergiesModal() {
        let content = '';
        if (data.allergies.length === 0 && data.allergiesChecked) {
            content = '<div class="modal-empty">ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ãªã—</div>';
        } else if (data.allergies.length === 0) {
            content = '<div class="modal-empty">æœªè¨˜è¼‰</div>';
        } else {
            content = '<ul class="modal-list">';
            data.allergies.forEach(allergy => {
                content += `<li class="modal-list-item">â€¢ ${allergy}</li>`;
            });
            content += '</ul>';
        }
        showModal('ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼', content);
    }

    function showMedicalHistoryModal() {
        let content = '';
        if (data.medicalHistory.length === 0 && data.medicalHistoryChecked) {
            content = '<div class="modal-empty">æ—¢å¾€æ­´ãªã—</div>';
        } else if (data.medicalHistory.length === 0) {
            content = '<div class="modal-empty">æœªè¨˜è¼‰</div>';
        } else {
            content = '<ul class="modal-list">';
            data.medicalHistory.forEach(item => {
                let text = item.condition;
                if (item.ageAtOnset) text += ` (${item.ageAtOnset}æ­³æ™‚)`;
                content += `<li class="modal-list-item">â€¢ ${text}</li>`;
            });
            content += '</ul>';
        }
        showModal('æ—¢å¾€æ­´', content);
    }

    function showMedicationsModal() {
        let content = '';
        if (data.medications.length === 0 && data.medicationsChecked) {
            content = '<div class="modal-empty">å†…æœè–¬ãªã—</div>';
        } else if (data.medications.length === 0) {
            content = '<div class="modal-empty">æœªè¨˜è¼‰</div>';
        } else {
            content = '<ul class="modal-list">';
            data.medications.forEach(med => {
                let text = med.name;
                if (med.targetCondition) {
                    text += ` (${med.targetCondition})`;
                }
                content += `<li class="modal-list-item">â€¢ ${text}</li>`;
            });
            content += '</ul>';
        }
        showModal('å†…æœè–¬', content);
    }

    function showFamilyHistoryModal() {
        let content = '';
        if ((data.familyHistory || []).length === 0 && data.familyHistoryChecked) {
            content = '<div class="modal-empty">å®¶æ—æ­´ãªã—</div>';
        } else if ((data.familyHistory || []).length === 0) {
            content = '<div class="modal-empty">æœªè¨˜è¼‰</div>';
        } else {
            content = '<ul class="modal-list">';
            (data.familyHistory || []).forEach(item => {
                const displayText = typeof item === 'object' && item.relationship && item.disease 
                    ? `${item.relationship} - ${item.disease}`
                    : item;
                content += `<li class="modal-list-item">â€¢ ${displayText}</li>`;
            });
            content += '</ul>';
        }
        showModal('å®¶æ—æ­´', content);
    }

    function showModal(title, content) {
        const modalHtml = `
            <div class="modal show" id="infoModal" onclick="closeModal(event)">
                <div class="modal-content" onclick="event.stopPropagation()">
                    <div class="modal-header">
                        <span class="modal-close" onclick="closeModal()">&times;</span>
                        ${title}
                    </div>
                    ${content}
                </div>
            </div>
        `;
        
        const existingModal = document.getElementById('infoModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
    }

    function closeModal(event) {
        const modal = document.getElementById('infoModal');
        if (modal && (event?.target === modal || !event)) {
            modal.remove();
        }
    }

    // åˆæœŸãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    render();

    // æ‰‹è¡“æ­´ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
    document.addEventListener('change', function(e) {
        if (e.target.id === 'newConditionSurgery') {
            const surgeryTypeInput = document.getElementById('newConditionSurgeryType');
            if (surgeryTypeInput) {
                surgeryTypeInput.style.display = e.target.checked ? 'block' : 'none';
            }
        }
    });

    // Service Workerç™»éŒ²
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(registration => {
                    console.log('Service Workerç™»éŒ²æˆåŠŸ:', registration.scope);
                })
                .catch(error => {
                    console.log('Service Workerç™»éŒ²å¤±æ•—:', error);
                });
        });
    }
</script>
</body>
</html>
